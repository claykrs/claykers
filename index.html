<!DOCTYPE html>

<html>
    <title>yuan idle [v0.0.2]</title>
    <body>
        <div style="display: flex; flex-direction: column;">
            <h1 id="yuan">0 Â¥</h1>
            <h3 id="output">+1 Â¥/s</h3>
            <button id="rebirth" disabled="true"></button>
            <button id="rebirth_s" disabled="true">ðŸ›’</button> 
            <div id="_upgrade_container"></div>
            <div id="yin_boost_container" style="
                padding: 10px;
                visibility: hidden;
                background-color: rgba(239,239,239, 0.3);
                border-radius: 1px;
                border: gray;
                font-family: sans-serif;
                overflow-y: auto;
                height: 100%;
            " >
                <p id="yin_available"></p>
            </div>
        </div>
    </body>

    <style>
        #yuan {
            margin-top: 0;
            margin-bottom: 4px;
        }

        #output {
            margin-top: 0;
            color: #111111;
            font-style: italic;
            font-weight: normal;
        }

        #rebirth {
            font-size: 14px;
            height: 30px;
            width: 300px;
         
            position: fixed;
            bottom: 30px;
            right: 45%;

            color: gray;
        }

        #rebirth_s {
            font-size: 14px;
            height: 30px;
            width: 50px;
            
            line-height: 50%;
            position: fixed;
            bottom: 30px;
            right: 43%;
        }

        #_upgrade_container {
            position: fixed;
            top: 36px;
            right: 1px;
            width: 320px;
            height: 91vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 5px;
        }
    </style>

    <script>      
        let idleT =
            Date.now()
        
        const template = {
            "yuan": 0,
            "yuanx": 0,

            "yin": 0,
            "has_rebirth": false,
            
            "_idle_output": 1,
            "_idle_rate": 1000,

            "upgrades": [
                { "price": 1E3, "owned": [0, 10], 
                    "value": [-50, "_idle_rate"], "mul": 10}
            ]
        }

        let price= 25, value = 1;        
        for (let i = 0; i < 50; i++) {
            template.upgrades.push({
                "price": price,
                "owned": [0, 100],
                "value": [value, "_idle_output"]
            });
        
            price *= 5;
            value *= 5;
        }

        function deep(arr) {
            return structuredClone(arr) }
        template.yin_boosts = Array(template.upgrades.length).fill(0)
        let data = deep(template)

        function openYinShop() {
            const container = document.getElementById("yin_boost_container")
            
            document.getElementById("yin_available").textContent = 
                `You have ${F(data.yin)} â˜¯`

            const oldRows = container.querySelectorAll(".yin_boost_row")
            oldRows.forEach(row => row.remove())

            data.upgrades.forEach((upg, i) => {
                let row = document.createElement("div")
                row.className = "yin_boost_row"
                row.style.marginBottom = "12px"

                let boostCount = data.yin_boosts[i]
                let boostMult = 1 + 0.05 * boostCount
                let newValue = upg.value[0] * boostMult
                let cost = (boostCount + 1) * 5

                row.innerHTML = `
                    <b>Upgrade ${i + 1}</b>: +${F(newValue)}${name(upg.value[1])}
                    <br>Boosts: ${boostCount}/5 
                    ${boostCount < 5 ? `| Cost: ${cost} â˜¯` : '| Maxed'}
                `

                if (boostCount < 5) {
                    let btn = document.createElement("button")
                    btn.textContent = "+ Boost"
                    btn.style.marginLeft = "10px"
                    btn.onclick = () => {
                        if (data.yin >= cost) {
                            data.yin -= cost
                            data.yin_boosts[i]++
                            openYinShop()
                        }
                    }
                    row.appendChild(btn)
                }

                container.appendChild(row)
            })
        }

        function name(k) {
            return (k == "_idle_output" && " Â¥/step" || 
                    (k == "_idle_rate" && " ms/step"))
        }

        function F(n) {
            const suffixes = [
                "", "thousand", "million", "billion", "trillion",
                "quadrillion", "quintillion", "sextillion", "septillion", "octillion", "nonillion",
                "decillion", "undecillion", "duodecillion", "tredecillion", "quattuordecillion",
                "quindecillion", "sexdecillion", "septendecillion", "octodecillion", "novemdecillion",
                "vigintillion", "unvigintillion", "duovigintillion", "trevigintillion", "quattuorvigintillion",
                "quinvigintillion", "sexvigintillion", "septenvigintillion", "octovigintillion", "novemvigintillion",
                "trigintillion", "untrigintillion", "duotrigintillion", "googol"
            ]

            const abs = Math.abs(n)
            if (abs >= 1E3 && abs < 1E6) {
                return n.toLocaleString(undefined, {
                    maximumFractionDigits: Number.isInteger(n) ? 0 : 2
                })
            }

            if (abs >= 1E6) {
                let i = 0, value = n
                while (Math.abs(value) >= 1E3
                    && i < suffixes.length - 1)
                {
                    value /= 1E3
                    i++
                }

                return value.toFixed(
                    Number.isInteger(value) ? 0 : 2)
                    + " " + suffixes[i]
            }

            return Number.isInteger(n)
                ? n.toString() : n.toFixed(2)
        }
        
        function N(n) {
            return Number((n).toFixed(2))
        }

        function maxBuy(upg) {
            let maxCanBuy = upg.owned[1] - upg.owned[0]
            let affordableCount = 0;
            let price = upg.price;
            let totalCost = 0;
            const mul = upg.mul || 1.15;
    
            for (let i = 0; i < maxCanBuy; i++) {
                if (totalCost + price > data.yuan) break;
                totalCost += price;
                price = Math.floor(price * mul);
                affordableCount++;
            }
            
            return { affordableCount, totalCost };
        }

        data.upgrades.forEach((upg, i) => {            
            let button = document.createElement("button")
            button.style.fontSize = "14px"; 
            button.style.height = "50px"
            button.style.width = "280px"
            button.id = `upg_${i+1}`
            
            button.innerHTML = `upgrade ${i+1} (${upg.owned[0]})`
                + `<br>+${F(upg.value[0])}${name(upg.value[1])}`
                  +`<br>-${F(upg.price)} Â¥`
            
            let container = document.getElementById("_upgrade_container")
                container.appendChild(button)
            container.appendChild(document.createElement("div"))

            button.onclick = function() {
                let upg = data.upgrades[i];
                if (upg.owned[0] >= upg.owned[1]) {
                    return
                }

                let { affordableCount, totalCost } = maxBuy(upg);
                if (affordableCount === 0) return;

                data.yuan -= totalCost;
                upg.owned[0] += affordableCount;
                data[upg.value[1]] += upg.value[0] * affordableCount;

                for (let j = 0; j < affordableCount; j++) {
                    upg.price = Math.floor(upg.price * (upg.mul || 1.15));
                }
            }
        })
        
        setInterval(function() {
            let content = `${F(data.yuan)} Â¥`
            if (data.yuanx > 1) {
                content += ` (${F(data.yuanx)}x mul)` }
            document.getElementById("yuan").textContent =  content
            document.getElementById("output").textContent = 
                `+${F(data._idle_output)} Â¥/step (${data._idle_rate >= 1E3 
                    && `${data._idle_rate / 1E3}s` || data._idle_rate + "ms"})`

            let rebirth = document.getElementById("rebirth")
            let text = "you cannot rebirth (1 million Â¥ required)"
            let yin = Math.floor(Math.cbrt(data.yuan / 1E6))
            let mul = N(Math.log10(data.yuan / 1E5))

            if (data.yuan >= 1E6 && yin > 0) {
                text = `rebirth for (+${F(yin)} â˜¯, +${F(mul)}x Â¥)`
                rebirth.disabled = false
                rebirth.style.color = "black"
            } else {
                rebirth.disabled = true
                rebirth.style.color = "gray"}
            if (rebirth.innerHTML != text) {
                rebirth.innerHTML = text
            }

            if (!rebirth.onclick) {
                rebirth.onclick = function() {
                    let yinG = Math.floor(Math.cbrt(data.yuan / 1E6))
                    let mulG = (Math.log10(data.yuan / 1E5))
                    
                    let yuanx = data.yuanx
                    let yin = data.yin
                    let upg = deep(data.yin_upgrades)

                    data = deep(template)
                    data.has_rebirth = true
                    data.yin = N(yin + yinG)
                    data.yuanx = N(yuanx + mulG)
                    data.yin_upgrades = upg
                }
            }

            data.upgrades.forEach((upg, i) => {
                let button = document.getElementById(`upg_${i+1}`)
                
                button.innerHTML = 
                    `${upg.value[0] > 0 && "+" || ""}`
                    + `${F(upg.value[0])}${name(upg.value[1])}`
                    + ` (${upg.owned[0] >= upg.owned[1] && "max"
                        || upg.owned[0] + "/" + upg.owned[1]})`
                      +`<br>cost ${F(upg.price)} Â¥`

                if (data.yuan >= upg.price) {
                    button.disabled = false
                    button.style.color = "black"
                } else {
                    button.disabled = true
                    button.style.color = "gray"
                }

                if (upg.owned[0] >= upg.owned[1]) {
                    button.disabled = true
                    button.style.color = "gray"
                }
            })

            let now = Date.now()
            let steps = Math.floor(((now - idleT)
                / 1E3 * 1E3) / data._idle_rate)

            if (steps > 0) {
                let mul = data.yuanx > 1 && data.yuanx || 1
                data.yuan += N((steps * data._idle_output) * mul)
                idleT += steps * data._idle_rate
            }
        }, 10)

        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) {
                idleT = Date.now()
            }
        })
    </script>
</html>
